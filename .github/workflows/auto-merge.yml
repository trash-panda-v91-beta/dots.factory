---
name: "Auto Merge"

on:
  pull_request:
    types:
      - opened
      - labeled
      - synchronize
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to enable auto-merge on"
        required: true

jobs:
  enable:
    name: "Enable Auto Merge"
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'merge-queue')
    steps:
      - name: Create GitHub App token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2
        id: app-token
        with:
          app-id: ${{ vars.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
        run: |-
          gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --auto \
            --rebase
